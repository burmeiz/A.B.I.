<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>üéì Meu Di√°rio de Estudo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Fonte -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet" />

  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      background-color: #0f172a;
      color: #f1f5f9;
      margin: 0;
      padding: 2rem;
    }
    h1 {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 2rem;
    }
    #login {
      text-align: center;
      margin-bottom: 2rem;
    }
    button {
      background: #00ffc8;
      color: #0f172a;
      font-weight: bold;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 6px #00ffc880;
    }
    textarea,
    input {
      width: 100%;
      max-width: 600px;
      display: block;
      margin: 1rem auto;
      padding: 0.8rem;
      background-color: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #f1f5f9;
    }
    #app {
      display: none;
      max-width: 800px;
      margin: auto;
    }
    ul {
      list-style: none;
      padding: 0;
      margin: 1rem auto;
      max-width: 600px;
    }
    li {
      padding: 0.5rem;
      border-bottom: 1px solid #334155;
    }
    .container {
      margin-top: 3rem;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1rem;
    }
    td,
    th {
      padding: 0.6rem;
      border: 1px solid #334155;
      text-align: center;
      min-width: 80px;
    }
    th {
      background-color: #1f2937;
    }
    h2 {
      border-bottom: 2px solid #334155;
      padding-bottom: 0.4rem;
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <h1>üéì Meu Di√°rio de Estudo</h1>
  <div id="login"></div>

  <div id="app">
    <textarea id="notes" rows="6" placeholder="Escreva suas anota√ß√µes aqui..."></textarea>
    <input type="text" id="gradeInput" placeholder="Nota (ex: Biologia - 8.5)" />
    <button onclick="save()">Salvar</button>

    <h2>Suas notas</h2>
    <ul id="gradesList"></ul>

    <div class="container">
      <h2>üßæ Boletim Individual</h2>
      <div id="dataTable">Carregando dados...</div>

      <h2>üìê Escalas de avalia√ß√£o</h2>
      <ul>
        <li>üî¢ 0‚Äì15: Nota oficial do Abitur</li>
        <li>üîü 0‚Äì10: Escala para GPA</li>
        <li>üìà %: Desempenho percentual</li>
        <li>üó£Ô∏è Descri√ß√£o: Interpreta√ß√£o qualitativa</li>
      </ul>
    </div>
  </div>

  <script>
    // Configura√ß√£o Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAR-WZNMiiF5c1u9UoObTGrs_iP5xnw5EU",
      authDomain: "arquivo-interdisciplinar.firebaseapp.com",
      projectId: "arquivo-interdisciplinar",
      storageBucket: "arquivo-interdisciplinar.appspot.com",
      messagingSenderId: "118743177993",
      appId: "1:118743177993:web:a6979d8aef0d27826c11d8",
      measurementId: "G-NES70LQ2RX"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const loginDiv = document.getElementById("login");
    const appDiv = document.getElementById("app");

    auth.onAuthStateChanged(user => {
      if (user) {
        loginDiv.innerHTML = `Ol√°, ${user.displayName} <button onclick="auth.signOut()">Sair</button>`;
        appDiv.style.display = "block";
        loadData(user.uid);
        loadStudentData(user.uid);
      } else {
        loginDiv.innerHTML = `<button onclick="auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())">Entrar com Google</button>`;
        appDiv.style.display = "none";
      }
    });

    function save() {
      const uid = auth.currentUser.uid;
      const note = document.getElementById("notes").value;
      const grade = document.getElementById("gradeInput").value;

      db.collection("users").doc(uid).set({ notes: note });

      if (grade) {
        db.collection("users").doc(uid).collection("grades").add({
          grade,
          timestamp: new Date()
        });
        document.getElementById("gradeInput").value = "";
        loadData(uid);
      }
    }

    function loadData(uid) {
      db.collection("users")
        .doc(uid)
        .get()
        .then(doc => {
          if (doc.exists) {
            document.getElementById("notes").value = doc.data().notes || "";
          }
        });

      db.collection("users")
        .doc(uid)
        .collection("grades")
        .orderBy("timestamp", "desc")
        .get()
        .then(snapshot => {
          const list = document.getElementById("gradesList");
          list.innerHTML = "";
          snapshot.forEach(doc => {
            const li = document.createElement("li");
            li.textContent = doc.data().grade;
            list.appendChild(li);
          });
        });
    }

    async function loadStudentData(uid) {
      const wrapper = document.getElementById("dataTable");
      wrapper.innerHTML = "Carregando...";

      const docRef = db.collection("users").doc(uid).collection("gradesheet").doc("table");
      const doc = await docRef.get();

      let rows = doc.exists
        ? doc.data().rows
        : [["Disciplina", "Nota (15)", "Nota (%)", "Nota (0-10)", "Descri√ß√£o"]];

      const table = document.createElement("table");
      const tbody = document.createElement("tbody");

      rows.forEach((row, rowIndex) => {
        const tr = document.createElement("tr");

        row.forEach((cell, colIndex) => {
          const tag = rowIndex === 0 ? "th" : "td";
          const el = document.createElement(tag);

          el.contentEditable = rowIndex !== 0;
          el.innerText = cell ?? "";
          el.dataset.row = rowIndex;
          el.dataset.col = colIndex;

          el.addEventListener("blur", () => {
            const r = parseInt(el.dataset.row);
            const c = parseInt(el.dataset.col);
            rows[r][c] = el.innerText;
            saveTable(uid, rows);
          });

          tr.appendChild(el);
        });

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      wrapper.innerHTML = "";

      const addButton = document.createElement("button");
      addButton.innerText = "‚ûï Adicionar linha";
      addButton.style.marginTop = "1rem";
      addButton.onclick = () => {
        const newRow = Array(rows[0].length).fill("");
        rows.push(newRow);
        saveTable(uid, rows);
        loadStudentData(uid); // recarrega a tabela
      };

      wrapper.appendChild(table);
      wrapper.appendChild(addButton);
    }

    async function saveTable(uid, rows) {
      const docRef = db.collection("users").doc(uid).collection("gradesheet").doc("table");
      await docRef.set({ rows });
      console.log("Tabela salva!");
    }
  </script>
</body>
</html>
